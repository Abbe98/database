#!/bin/bash

#
# The HARestore script will recreate the Blazegraph HA journal file as of
# the most recent commit point from log and snapshot files.  The
# intended use of the script is to restore a journal file that resides
# on an ephemeral storage media (especially, an SSD instance disk)
# from a combination of full backups and transaction logs on durable
# media (e.g., EBS) following a system reboot.  The script should not
# be executed while Blazegraph is running (it requires exclusive access
# to the journal and will not be able to run if bigdata is already
# running).
#
# HARestore takes no arguments and assumes the Blazegraph journal filename\
# convention: "bigdata-ha.jnl".
#

source /etc/default/blazegraph-ha

SERVICE_DIR="$FED_DIR/$FEDNAME/$LOGICAL_SERVICE_ID/HAJournalServer"
LIB_DIR="$BLZG_HOME/lib"

#Default HA journal file name
JNL_FILE="bigdata-ha.jnl"

# TODO Explicitly enumerate JARs so we can control order if necessary and
# deploy on OS without find and tr.
export HAJOURNAL_CLASSPATH=`find ${LIB_DIR} -name '*.jar' -print0 | tr '\0' ':'`

java -cp ${HAJOURNAL_CLASSPATH} \
     -Dlog4j.configuration=file:"${BLZG_HOME}"/conf/log4jHA.properties \
     com.bigdata.journal.jini.ha.HARestore \
     -o "$DATA_DIR"/"$JNL_FILE" \
     "$SNAPSHOT_DIR" \
     "$HALOG_DIR" \

chown $BLZG_USER:BLZG_GROUP "$DATA_DIR"/"$JNL_FILE"
